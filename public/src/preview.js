const STORAGE_KEY="leaveFormData_v1";function encodeData(e){return encodeURIComponent(JSON.stringify(e))}function decodeData(e){try{return JSON.parse(decodeURIComponent(e))}catch(e){return console.error("解码数据失败:",e),null}}function loadFormDataPreview(){try{const e=localStorage.getItem(STORAGE_KEY);if(!e)return alert("未找到表单数据，请返回填写表单"),void(window.location.href="index.html");const t=decodeData(e);if(!t)return alert("数据格式错误，请返回重新填写表单"),void(window.location.href="index.html");Object.keys(t).forEach(e=>{if("sealTime"===e||"applyDateTime"===e)return;const n=document.getElementById(e);n&&("INPUT"===n.tagName||"SELECT"===n.tagName?n.value=t[e]:n.textContent=t[e])});const n=document.getElementById("ethnic");n&&t.ethnic&&(n.textContent=t.ethnic);const o=document.getElementById("sealTime");if(o)if(t.sealTime)o.textContent=t.sealTime;else if(t.applyDate){const e=new Date(t.applyDate),n=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")} 00:00`;o.textContent=n}const c=document.getElementById("tutorDate");c&&t.applyDate&&(c.textContent=t.applyDate)}catch(e){console.error("加载预览数据失败:",e),alert("加载预览数据失败，请返回重试"),window.location.href="index.html"}}function initPreviewPage(){loadFormDataPreview(),document.getElementById("backBtn").addEventListener("click",function(){window.location.href="index.html"}),document.getElementById("closeBtn").addEventListener("click",async function(){try{if(Boolean(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement))document.exitFullscreen?await document.exitFullscreen():document.webkitExitFullscreen?await document.webkitExitFullscreen():document.mozCancelFullScreen?await document.mozCancelFullScreen():document.msExitFullscreen&&await document.msExitFullscreen();else{const e=document.documentElement;if(e.requestFullscreen)await e.requestFullscreen({navigationUI:"hide"});else if(e.webkitRequestFullscreen)await e.webkitRequestFullscreen();else if(e.mozRequestFullScreen)await e.mozRequestFullScreen();else{if(!e.msRequestFullscreen)throw new Error("浏览器不支持 Fullscreen API");await e.msRequestFullscreen()}}}catch(e){console.error("页面全屏切换失败:",e),alert("页面全屏切换失败："+e.message)}}),document.getElementById("tabRegister").addEventListener("click",function(){this.classList.add("active"),document.getElementById("tabProcess").classList.remove("active")}),document.getElementById("tabProcess").addEventListener("click",function(){this.classList.add("active"),document.getElementById("tabRegister").classList.remove("active")});const e=document.getElementById("sealId");if(e&&(!e.textContent||"2a24c622f84547ab"===e.textContent)){const t=(Math.random().toString(16).slice(2)+Math.random().toString(16).slice(2)).slice(0,16);e.textContent=t}initMaskGrid()}function createMaskText(){try{const e=localStorage.getItem(STORAGE_KEY);if(!e)return"未找到请假信息";const t=decodeData(e);if(!t||!t.name)return"未找到姓名信息";const n=new Date,o=`${n.getFullYear()}年${n.getMonth()+1}月${n.getDate()}日${n.getHours()}:${n.getMinutes()}:${n.getSeconds()}`;return`${t.name} ${o}`}catch(e){return console.error("获取水印信息失败:",e),"水印生成失败"}}function initMaskGrid(){const e=document.querySelector(".mask_divs");if(!e)return;const t=createMaskText(),n=[10,260];for(;e.firstChild;)e.removeChild(e.firstChild);for(let o=0;o<15;o++)for(let c=0;c<2;c++){const a=document.createElement("div");a.className="mask_div",a.innerText=t,a.style.left=`${n[c]}px`,a.style.top=10+100*o+"px",e.appendChild(a)}}function generateQRCode(){try{const e=localStorage.getItem(STORAGE_KEY);if(!e)return void console.error("未找到表单数据，无法生成二维码");const t=decodeData(e);if(!t)return void console.error("解析表单数据失败，无法生成二维码");const n={leaveTime:`${t.leaveStart} 至 ${t.leaveEnd}`,department:t.department||"",major:t.major||"",class:t.class||"",name:t.name||"",studentId:t.studentId||""},o=`https://jt.dogxi.me/result.html?d=${LZString.compressToEncodedURIComponent(JSON.stringify(n))}`,c=qrcode(0,"L");c.addData(o),c.make();const a=4,r=24,l=c.createDataURL(a,r),i=document.querySelector(".qrcode");i&&(i.src=l),console.log("二维码生成成功")}catch(e){console.error("生成二维码时发生错误:",e)}}document.addEventListener("DOMContentLoaded",function(){initPreviewPage(),generateQRCode()});