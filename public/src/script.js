const STORAGE_KEY="leaveFormData_v1";function encodeData(e){return encodeURIComponent(JSON.stringify(e))}function decodeData(e){try{return JSON.parse(decodeURIComponent(e))}catch(e){return console.error("解码数据失败:",e),null}}function saveFormData(){const e={},t=document.getElementById("leaveForm");t.querySelectorAll('input[type="text"], input[type="tel"], input[type="date"], select').forEach(t=>{e[t.id]=t.value});["gender","leaveType","agent","parentAware"].forEach(a=>{const n=t.querySelector(`input[name="${a}"]:checked`);e[a]=n?n.value:""});const a=document.getElementById("leaveStart").value,n=document.getElementById("leaveEnd").value;if(a&&n){const t=new Date(a),o=new Date(n),c=Math.abs(o-t),l=Math.ceil(c/864e5)+1;e.leaveDays=l,document.getElementById("leaveDays").textContent=l}const o=document.getElementById("applyDate");if(o&&o.value){const t=new Date(o.value);e.applyDateTime=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String((new Date).getHours()).padStart(2,"0")}:${String((new Date).getMinutes()).padStart(2,"0")}`,e.applyDate=o.value,e.sealTime=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} 00:00`}try{localStorage.setItem(STORAGE_KEY,encodeData(e))}catch(e){console.error("保存数据失败:",e)}}function loadFormData(){try{const e=localStorage.getItem(STORAGE_KEY);if(!e)return;const t=decodeData(e);if(!t)return;const a=document.getElementById("leaveForm");Object.keys(t).forEach(e=>{const a=document.getElementById(e);if(!a||"INPUT"!==a.tagName&&"SELECT"!==a.tagName){if("leaveDays"===e){const a=document.getElementById("leaveDays");a&&(a.textContent=t[e])}}else a.value=t[e]});["gender","leaveType","agent","parentAware"].forEach(e=>{if(t[e]){const n=a.querySelector(`input[name="${e}"][value="${t[e]}"]`);n&&(n.checked=!0)}})}catch(e){console.error("加载数据失败:",e)}}function calculateLeaveDays(){const e=document.getElementById("leaveStart").value,t=document.getElementById("leaveEnd").value;if(e&&t){const a=new Date(e),n=new Date(t);if(n<a)return alert("结束日期不能早于开始日期"),document.getElementById("leaveEnd").value=e,void(document.getElementById("leaveDays").textContent="1");const o=Math.abs(n-a),c=Math.ceil(o/864e5)+1;document.getElementById("leaveDays").textContent=c}}function validateForm(){const e=[{id:"contact",name:"联系方式"},{name:"gender",type:"radio",label:"性别"},{id:"ethnic",name:"民族"},{name:"leaveType",type:"radio",label:"请假类型"},{name:"agent",type:"radio",label:"是否代请假"},{id:"leaveStart",name:"请假开始时间"},{id:"leaveEnd",name:"请假结束时间"},{name:"parentAware",type:"radio",label:"家长是否知晓"},{id:"destinationType",name:"请假去向类型"},{id:"destinationDetail",name:"请假去向（具体地点）"},{id:"reason",name:"请假事由"}];for(const t of e)if("radio"===t.type){if(!document.querySelector(`input[name="${t.name}"]:checked`))return alert(`请选择${t.label}`),!1}else{const e=document.getElementById(t.id);if(!e.value.trim())return alert(`请填写${t.name}`),e.focus(),!1}return!0}function initForm(){loadFormData(),document.getElementById("leaveStart").addEventListener("change",function(){calculateLeaveDays(),saveFormData()}),document.getElementById("leaveEnd").addEventListener("change",function(){calculateLeaveDays(),saveFormData()});document.getElementById("leaveForm").querySelectorAll("input, select").forEach(e=>{e.addEventListener("change",saveFormData),e.addEventListener("blur",saveFormData)}),document.getElementById("btnNext").addEventListener("click",function(e){e.preventDefault(),validateForm()&&(saveFormData(),window.location.href="preview.html")}),document.getElementById("backBtn").addEventListener("click",function(){history.back()}),document.getElementById("closeBtn").addEventListener("click",function(){confirm("确定要关闭页面吗？")&&(window.close(),window.location.href="about:blank")}),document.getElementById("tabRegister").addEventListener("click",function(){this.classList.add("active"),document.getElementById("tabProcess").classList.remove("active")}),document.getElementById("tabProcess").addEventListener("click",function(){this.classList.add("active"),document.getElementById("tabRegister").classList.remove("active")}),calculateLeaveDays(),window.addEventListener("beforeunload",saveFormData)}document.addEventListener("DOMContentLoaded",initForm);